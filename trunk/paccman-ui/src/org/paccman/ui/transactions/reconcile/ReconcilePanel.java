/*
 * ReconcilePanel.java
 *
 * Created on 14 novembre 2005, 14:54
 */

package org.paccman.ui.transactions.reconcile;

import java.math.BigDecimal;
import java.text.ParseException;
import java.util.Calendar;
import java.util.GregorianCalendar;

/**
 *
 * @author  jfer
 */
public class ReconcilePanel extends javax.swing.JPanel {
    
    ReconcileContext context = new ReconcileContext();
    
    private void updateForm() {
        newBalanceEdt.setValue(context.newBalance);
        differencePrevNewEdt.setValue(context.diffBalance);
        diffDifferenceMarkedEdt.setValue(context.diffMarkedBalance);
        markedAmountEdt.setValue(context.markedAmount);
    }
    
    private void updateNewBalance(BigDecimal amount) {
        context.newBalance = amount;
        
        context.diffBalance = context.newBalance.subtract(context.prevBalance);
        context.diffMarkedBalance = context.diffBalance.subtract(context.markedAmount);
        
        updateForm();
    }
    
    private void updateMarkedBalance(BigDecimal amount) {
        context.markedAmount = amount;
        
        context.diffMarkedBalance = context.diffBalance.subtract(context.markedAmount);

        updateForm();
    }
    
    private void updateMarkedAndNewBalance(BigDecimal markedAmount, BigDecimal newBalance) {
        context.newBalance   = newBalance;
        context.markedAmount = markedAmount;
        
        context.diffBalance = context.prevBalance.subtract(context.newBalance);
        context.diffMarkedBalance = context.markedAmount.subtract(context.diffBalance);

        updateForm();
    }
    
    /** Creates new form ReconcilePanel */
    public ReconcilePanel() {
        initComponents();
    }
    
    public void setData(Calendar prevReconciliationDate, BigDecimal prevReconcilationBalance,
            Calendar pendingReconciliationDate, BigDecimal pendingReconciliationBalance,
            BigDecimal markedAmount) {
        
        // Previous reconciliation
        context.prevBalance = prevReconcilationBalance;
        context.newDate = pendingReconciliationDate;
        prevBalanceEdt.setValue(prevReconcilationBalance);
        prevDateChooser.setDate(prevReconciliationDate.getTime());
        newDateChooser.setDate(pendingReconciliationDate.getTime());
        
        // Pending or new reconciliation
        updateMarkedAndNewBalance(markedAmount, pendingReconciliationBalance);

    }
    
    public void markTransactionAmount(BigDecimal amount) {
        updateMarkedBalance(context.markedAmount.add(amount));
    }
    
    public void unmarkTransactionAmount(BigDecimal amount) {
        updateMarkedBalance(context.markedAmount.subtract(amount));
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        previousPanel = new javax.swing.JPanel();
        prevDateChooser = new org.paccman.ui.common.MyDateChooser();
        prevBalanceEdt = new org.paccman.ui.common.AmountTextField();
        newPanel = new javax.swing.JPanel();
        newDateChooser = new org.paccman.ui.common.MyDateChooser();
        newBalanceEdt = new org.paccman.ui.common.AmountTextField();
        differencePanel = new javax.swing.JPanel();
        differencePrevNewEdt = new org.paccman.ui.common.AmountTextField();
        markedAmountEdt = new org.paccman.ui.common.AmountTextField();
        diffDifferenceMarkedEdt = new org.paccman.ui.common.AmountTextField();

        setLayout(new javax.swing.BoxLayout(this, javax.swing.BoxLayout.Y_AXIS));

        previousPanel.setBorder(javax.swing.BorderFactory.createTitledBorder("Previous"));

        prevDateChooser.setEnabled(false);

        prevBalanceEdt.setEnabled(false);

        javax.swing.GroupLayout previousPanelLayout = new javax.swing.GroupLayout(previousPanel);
        previousPanel.setLayout(previousPanelLayout);
        previousPanelLayout.setHorizontalGroup(
            previousPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(previousPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(previousPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(prevDateChooser, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 249, Short.MAX_VALUE)
                    .addComponent(prevBalanceEdt, javax.swing.GroupLayout.DEFAULT_SIZE, 249, Short.MAX_VALUE))
                .addContainerGap())
        );
        previousPanelLayout.setVerticalGroup(
            previousPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(previousPanelLayout.createSequentialGroup()
                .addComponent(prevDateChooser, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(prevBalanceEdt, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        add(previousPanel);

        newPanel.setBorder(javax.swing.BorderFactory.createTitledBorder("New"));

        newBalanceEdt.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                newBalanceEdtFocusLost(evt);
            }
        });

        javax.swing.GroupLayout newPanelLayout = new javax.swing.GroupLayout(newPanel);
        newPanel.setLayout(newPanelLayout);
        newPanelLayout.setHorizontalGroup(
            newPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(newPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(newPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(newBalanceEdt, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 249, Short.MAX_VALUE)
                    .addComponent(newDateChooser, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 249, Short.MAX_VALUE))
                .addContainerGap())
        );
        newPanelLayout.setVerticalGroup(
            newPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(newPanelLayout.createSequentialGroup()
                .addComponent(newDateChooser, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(newBalanceEdt, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        add(newPanel);

        differencePanel.setBorder(javax.swing.BorderFactory.createTitledBorder("Difference"));

        differencePrevNewEdt.setEnabled(false);

        markedAmountEdt.setEnabled(false);

        diffDifferenceMarkedEdt.setEnabled(false);

        javax.swing.GroupLayout differencePanelLayout = new javax.swing.GroupLayout(differencePanel);
        differencePanel.setLayout(differencePanelLayout);
        differencePanelLayout.setHorizontalGroup(
            differencePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, differencePanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(differencePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(markedAmountEdt, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 249, Short.MAX_VALUE)
                    .addComponent(differencePrevNewEdt, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 249, Short.MAX_VALUE)
                    .addComponent(diffDifferenceMarkedEdt, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 249, Short.MAX_VALUE))
                .addContainerGap())
        );
        differencePanelLayout.setVerticalGroup(
            differencePanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(differencePanelLayout.createSequentialGroup()
                .addComponent(differencePrevNewEdt, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(markedAmountEdt, javax.swing.GroupLayout.PREFERRED_SIZE, 19, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(diffDifferenceMarkedEdt, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        add(differencePanel);
    }// </editor-fold>//GEN-END:initComponents
    
    private void newBalanceEdtFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_newBalanceEdtFocusLost
        try {
            newBalanceEdt.commitEdit();
        } catch (ParseException ex) {
            return;
        }
        updateNewBalance(newBalanceEdt.getValue());
    }//GEN-LAST:event_newBalanceEdtFocusLost
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private org.paccman.ui.common.AmountTextField diffDifferenceMarkedEdt;
    private javax.swing.JPanel differencePanel;
    private org.paccman.ui.common.AmountTextField differencePrevNewEdt;
    private org.paccman.ui.common.AmountTextField markedAmountEdt;
    private org.paccman.ui.common.AmountTextField newBalanceEdt;
    private org.paccman.ui.common.MyDateChooser newDateChooser;
    private javax.swing.JPanel newPanel;
    private org.paccman.ui.common.AmountTextField prevBalanceEdt;
    private org.paccman.ui.common.MyDateChooser prevDateChooser;
    private javax.swing.JPanel previousPanel;
    // End of variables declaration//GEN-END:variables
    
    public ReconcileContext getData() {
        context.newDate = newDateChooser.getCalendarDate();
        return context;
    }
}
